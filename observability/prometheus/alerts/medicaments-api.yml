groups:
  - name: medicaments_api
    interval: 30s
    rules:
      # Critical: Service Down
      - alert: ServiceDown
        expr: up{job="medicaments-api"} == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Service {{ $labels.instance }} is down"
          description: "Service unreachable for >5m"
      
      # Critical: High 5xx Rate
      - alert: High5xxErrorRate
        expr: |
          (rate(http_request_total{job="medicaments-api",status=~"5.."}[5m])
          / rate(http_request_total{job="medicaments-api"}[5m])) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "5xx error rate is {{ $value | humanizePercentage }}"
          description: "Threshold: 5%"
      
      # Critical: High Total Errors
      - alert: HighTotalErrorRate
        expr: |
          (rate(http_request_total{job="medicaments-api",status=~"[45].."}[5m])
          / rate(http_request_total{job="medicaments-api"}[5m])) > 0.10
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Error rate is {{ $value | humanizePercentage }}"
          description: "Threshold: 10%"
      
      # Warning: High Latency (P95)
      - alert: HighLatencyP95
        expr: |
          histogram_quantile(0.95,
            rate(http_request_duration_seconds_bucket{job="medicaments-api"}[10m])
          ) > 0.2
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "P95 latency is {{ $value | humanizeDuration }}"
          description: "Threshold: 200ms"
      
      # Warning: High Request Rate
      - alert: HighRequestRate
        expr: rate(http_request_total{job="medicaments-api"}[5m]) > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Request rate is {{ $value }} req/sec"
          description: "Threshold: 1000"
      
      # Warning: Sustained 4xx Rate
      - alert: Sustained4xxRate
        expr: |
          (rate(http_request_total{job="medicaments-api",status=~"4.."}[10m])
          / rate(http_request_total{job="medicaments-api"}[10m])) > 0.05
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "4xx rate is {{ $value | humanizePercentage }}"
          description: "Threshold: 5% over 10m"
