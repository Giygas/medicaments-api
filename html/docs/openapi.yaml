openapi: 3.1.0
info:
  title: API Médicaments FR
  description: |
    API RESTful haute performance pour accéder aux données des médicaments français.

    Architecture basée sur interfaces avec parsing concurrent BDPM, zero-downtime updates, 
    cache HTTP intelligent et rate limiting par token bucket.

    ## Caractéristiques
    - 15K+ médicaments issus de la BDPM
    - Mises à jour automatiques 2x/jour (6h/18h)
    - Rate limiting : 1000 tokens initiaux, 3 tokens/sec recharge
    - Cache HTTP avec ETag/Last-Modified
    - Compression gzip (80% réduction)
    - Temps de réponse ~2.1s (dataset complet), <100ms (recherche)

    ## Intégrité des données
    - Intégrité : Aucune altération des données originales
    - Source : Base de Données Publique des Médicaments (BDPM)

    ## Coûts par endpoint
    - `/health` : 5 tokens
    - `/database/{page}` : 20 tokens  
    - `/generiques/{libelle}` : 20 tokens
    - `/generiques/group/{id}` : 20 tokens
    - `/medicament/{nom}` : 100 tokens
    - `/medicament/id/{cis}` : 100 tokens
    - `/database` : 200 tokens

    ## Headers Rate Limiting
    Les informations relatives au rate limiting se trouvent dans les headers de l'endpoint /health :

    - X-RateLimit-Limit : Capacité maximale de tokens
    - X-RateLimit-Remaining : Tokens restants pour cette IP  
    - X-RateLimit-Rate : Taux de recharge (tokens/sec)

    Pour obtenir seulement les headers : curl -I "https://medicamentsapi.giygas.dev/health"
  version: 1.0.0
  contact:
    name: GitHub Repository
    url: https://github.com/giygas/medicaments-api
  license:
    name: AGPL-3.0
    url: https://www.gnu.org/licenses/agpl-3.0.html
externalDocs:
  description: Base de données publique des médicaments
  url: https://base-donnees-publique.medicaments.gouv.fr

paths:
  /database:
    get:
      summary: Obtenir tous les médicaments
      description: Récupérer la liste complète de tous les médicaments dans la base de données
      tags:
        - Médicaments
      x-token-cost: 200
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/MedicamentResponse"
              example:
                - cis: 61504672
                  elementPharmaceutique: "PARACETAMOL MYLAN 1 g, comprimé"
                  formePharmaceutique: "comprimé"
                  voiesAdministration: ["orale"]
                  statusAutorisation: "Autorisation active"
                  typeProcedure: "Procédure nationale"
                  etatComercialisation: "Commercialisée"
                  dateAMM: "2000-01-01"
                  titulaire: "MYLAN SAS"
                  surveillanceRenforce: "Non"
                  composition:
                    - cis: 61504672
                      elementPharmaceutique: "paracétamol"
                      codeSubstance: 12345
                      denominationSubstance: "PARACETAMOL"
                      dosage: "1,000 g"
                      referenceDosage: "1,000 g"
                      natureComposant: "substance active"
                  generiques:
                    - cis: 61504672
                      group: 1234
                      libelle: "PARACETAMOL 1 g, comprimé"
                      type: "Princeps"
                  presentation:
                    - cis: 61504672
                      cip7: 1234567
                      libelle: "PARACETAMOL MYLAN 1 g, comprimé pelliculé, boîte de 8"
                      statusAdministratif: "Présentation active"
                      etatComercialisation: "Commercialisée"
                      dateDeclaration: "2000-01-01"
                      cip13: 3400912345678
                      agreement: "Oui"
                      tauxRemboursement: "65%"
                      prix: 2.45
                  conditions:
                    - "Médicament soumis à prescription médicale"
                    - "Non remboursable si prescrit hors AMM"

        "400":
          description: Invalid page number
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Bad Request"
                message: "Invalid page number"
                code: 400
        "404":
          description: Page not found (exceeds maximum pages)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Not Found"
                message: "Page not found"
                code: 404
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Not Found"
                message: "Page not found"
                code: 404

  /medicament/{element}:
    get:
      summary: Rechercher des médicaments par nom
      description: Rechercher des médicaments par dénomination (insensible à la casse)
      tags:
        - Médicaments
      x-token-cost: 100
      parameters:
        - name: element
          in: path
          required: true
          description: Search term (3-50 characters, alphanumeric with spaces)
          schema:
            type: string
            minLength: 3
            maxLength: 50
            pattern: "^[a-zA-Z0-9 ]+$"
          example: "paracetamol"
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/MedicamentResponse"
              example:
                - cis: 61504672
                  elementPharmaceutique: "PARACETAMOL MYLAN 1 g, comprimé"
                  formePharmaceutique: "comprimé"
                  voiesAdministration: ["orale"]
                  statusAutorisation: "Autorisation active"
                  typeProcedure: "Procédure nationale"
                  etatComercialisation: "Commercialisée"
                  dateAMM: "2000-01-01"
                  titulaire: "MYLAN SAS"
                  surveillanceRenforce: "Non"
                  composition: []
                  generiques: []
                  presentation: []
                  conditions: []
                - cis: 60001234
                  elementPharmaceutique: "DOLIPRANE 1000 mg, comprimé"
                  formePharmaceutique: "comprimé"
                  voiesAdministration: ["orale"]
                  statusAutorisation: "Autorisation active"
                  typeProcedure: "Procédure nationale"
                  etatComercialisation: "Commercialisée"
                  dateAMM: "1998-05-15"
                  titulaire: "SANOFI AVENTIS FRANCE"
                  surveillanceRenforce: "Non"
                  composition: []
                  generiques: []
                  presentation: []
                  conditions: []


        "400":
          description: Invalid search term
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Bad Request"
                message: "Terme de recherche invalide : doit être alphanumérique avec espaces, max 50 caractères"
                code: 400
        "404":
          description: No medicaments found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Not Found"
                message: "No medicaments found"
                code: 404
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Internal Server Error"
                message: "Internal server error"
                code: 500



  /medicament/id/{cis}:
    get:
      summary: Obtenir un médicament par code CIS
      description: Récupérer un médicament spécifique par son CIS (Code Identifiant de Spécialité)
      tags:
        - Médicaments
      x-token-cost: 100
      parameters:
        - name: cis
          in: path
          required: true
          description: CIS code (positive integer less than 1,000,000,000)
          schema:
            type: integer
            minimum: 1
            maximum: 999999999
          example: 61504672
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MedicamentResponse"

        "400":
          description: Invalid CIS code
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Bad Request"
                message: "Invalid CIS"
                code: 400
        "404":
          description: Medicament not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Not Found"
                message: "Medicament not found"
                code: 404
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Internal Server Error"
                message: "Internal server error"
                code: 500


  /generiques/{libelle}:
    get:
      summary: Rechercher des groupes génériques par nom
      description: Rechercher des groupes génériques par libellé (insensible à la casse)
      tags:
        - Génériques
      x-token-cost: 20
      parameters:
        - name: libelle
          in: path
          required: true
          description: Search term (3-50 characters, alphanumeric with spaces)
          schema:
            type: string
            minLength: 3
            maxLength: 50
            pattern: "^[a-zA-Z0-9 ]+$"
          example: "paracetamol"
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/GeneriqueListResponse"

        "400":
          description: Invalid search term
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Bad Request"
                message: "Terme de recherche invalide : doit être alphanumérique avec espaces, max 50 caractères"
                code: 400
        "404":
          description: No generics found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Not Found"
                message: "No generiques found"
                code: 404
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Internal Server Error"
                message: "Internal server error"
                code: 500



  /generiques/group/{groupId}:
    get:
      summary: Obtenir un groupe générique par ID
      description: Récupérer un groupe générique spécifique par son ID de groupe
      tags:
        - Génériques
      x-token-cost: 20
      parameters:
        - name: groupId
          in: path
          required: true
          description: Group ID (positive integer less than 100,000)
          schema:
            type: integer
            minimum: 1
            maximum: 99999
          example: 1234
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GeneriqueResponse"

        "400":
          description: Invalid group ID
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Bad Request"
                message: "Invalid group ID"
                code: 400
        "404":
          description: Generic group not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Not Found"
                message: "Generique group not found"
                code: 404
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Internal Server Error"
                message: "Internal server error"
                code: 500



  /health:
    get:
      summary: Point de terminaison de vérification de santé
      description: Vérifier l'état de santé de l'API et de la base de données
      tags:
        - Système
      x-token-cost: 5
      responses:
        "200":
          description: System health
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: ["healthy", "degraded", "unhealthy"]
                    example: "healthy"
                    description: État de santé global de l'API
                  uptime_seconds:
                    type: integer
                    example: 86400
                    description: Temps de fonctionnement en secondes
                  uptime_human:
                    type: string
                    example: "1d 2h 30m 45s"
                    description: Temps de fonctionnement au format lisible
                  last_updated:
                    type: string
                    format: date-time
                    example: "2025-01-15T06:00:00Z"
                    description: Date et heure de la dernière mise à jour réussie
                  data:
                    type: object
                    properties:
                      medicament_count:
                        type: integer
                        example: 15420
                        description: Nombre total de médicaments dans la base
                      generique_count:
                        type: integer
                        example: 5200
                        description: Nombre total de groupes génériques
                      data_age_hours:
                        type: number
                        format: float
                        example: 2.5
                        description: Âge des données en heures depuis la dernière mise à jour
                      next_update:
                        type: string
                        format: date-time
                        example: "2025-01-15T18:00:00Z"
                        description: Prochaine mise à jour planifiée
                    description: Informations sur les données de l'API
                  system:
                    type: object
                    properties:
                      updating:
                        type: boolean
                        example: false
                        description: Indique si une mise à jour est en cours
                      memory_usage_mb:
                        type: integer
                        example: 130
                        description: Utilisation mémoire en MB
                      goroutines:
                        type: integer
                        example: 45
                        description: Nombre de goroutines actives
                    description: Informations système et performance
                example:
                  status: "healthy"
                  uptime_seconds: 86400
                  uptime_human: "1d 0h 0m 0s"
                  last_updated: "2025-01-15T06:00:00Z"
                  data:
                    medicament_count: 15420
                    generique_count: 5200
                    data_age_hours: 2.5
                    next_update: "2025-01-15T18:00:00Z"
                  system:
                    updating: false
                    memory_usage_mb: 130
                    goroutines: 45
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Internal Server Error"
                message: "Internal server error"
                code: 500

tags:
  - name: Médicaments
    description: Points de terminaison liés aux médicaments
  - name: Génériques
    description: Points de terminaison des groupes de médicaments génériques
  - name: Système
    description: Points de terminaison de santé et d'état du système

components:
  schemas:
    MedicamentResponse:
      type: object
      title: MedicamentResponse
      properties:
        cis:
          type: integer
          title: CIS Code
        elementPharmaceutique:
          type: string
          title: Pharmaceutical Name
        formePharmaceutique:
          type: string
          title: Pharmaceutical Form
        voiesAdministration:
          type: array
          items:
            type: string
          title: Administration Routes
        statusAutorisation:
          type: string
          title: Authorization Status
        typeProcedure:
          type: string
          title: Procedure Type
        etatComercialisation:
          type: string
          title: Commercialization Status
        dateAMM:
          type: string
          title: AMM Date
        titulaire:
          type: string
          title: Authorization Holder
        surveillanceRenforce:
          type: string
          title: Enhanced Surveillance
        composition:
          type: array
          items:
            $ref: "#/components/schemas/CompositionResponse"
          title: Composition
        generiques:
          type: array
          items:
            $ref: "#/components/schemas/GeneriqueResponse"
          title: Associated Generics
        presentation:
          type: array
          items:
            $ref: "#/components/schemas/PresentationResponse"
          title: Available Presentations
        conditions:
          type: array
          items:
            type: string
          title: Prescription Conditions

    CompositionResponse:
      type: object
      title: CompositionResponse
      properties:
        cis:
          type: integer
          title: CIS Code
        elementPharmaceutique:
          type: string
          title: Pharmaceutical Element
        codeSubstance:
          type: integer
          title: Substance Code
        denominationSubstance:
          type: string
          title: Substance Denomination
        dosage:
          type: string
          title: Dosage
        referenceDosage:
          type: string
          title: Reference Dosage
        natureComposant:
          type: string
          title: Component Nature

    GeneriqueResponse:
      type: object
      title: GeneriqueResponse
      properties:
        cis:
          type: integer
          title: CIS Code
        group:
          type: integer
          title: Generic Group ID
        libelle:
          type: string
          title: Generic Group Label
        type:
          type: string
          title: Generic Type

    PresentationResponse:
      type: object
      title: PresentationResponse
      properties:
        cis:
          type: integer
          title: CIS Code
        cip7:
          type: integer
          title: CIP-7 Code
        libelle:
          type: string
          title: Presentation Label
        statusAdministratif:
          type: string
          title: Administrative Status
        etatComercialisation:
          type: string
          title: Commercialization Status
        dateDeclaration:
          type: string
          title: Declaration Date
        cip13:
          type: integer
          title: CIP-13 Code
        agreement:
          type: string
          title: Agreement Status
        tauxRemboursement:
          type: string
          title: Reimbursement Rate
        prix:
          type: number
          format: float
          title: Price

    GeneriqueListResponse:
      type: object
      title: GeneriqueListResponse
      properties:
        groupID:
          type: integer
          title: Generic Group ID
        libelle:
          type: string
          title: Generic Group Label
        medicaments:
          type: array
          items:
            $ref: "#/components/schemas/GeneriqueMedicamentResponse"
          title: Medicaments in Group

    GeneriqueMedicamentResponse:
      type: object
      title: GeneriqueMedicamentResponse
      properties:
        cis:
          type: integer
          title: CIS Code
        elementPharmaceutique:
          type: string
          title: Pharmaceutical Name
        formePharmaceutique:
          type: string
          title: Pharmaceutical Form
        type:
          type: string
          title: Generic Type
        composition:
          type: array
          items:
            $ref: "#/components/schemas/GeneriqueCompositionResponse"
          title: Composition for Generic Grouping

    GeneriqueCompositionResponse:
      type: object
      title: GeneriqueCompositionResponse
      properties:
        elementPharmaceutique:
          type: string
          title: Pharmaceutical Element
        substance:
          type: string
          title: Substance Name
        dosage:
          type: string
          title: Dosage

    ErrorResponse:
      type: object
      title: ErrorResponse
      properties:
        error:
          type: string
          title: Error Status
        message:
          type: string
          title: Error Message
        code:
          type: integer
          title: HTTP Status Code
