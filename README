# Medicaments API

Une API RESTful optimis√©e qui fournit un acc√®s programmatique aux donn√©es publiques
des m√©dicaments fran√ßais via parsing concurrent de 5 sources BDPM, atomic zero-downtime updates,
et rate limiting par token bucket.

## Objectif

Les donn√©es officielles des m√©dicaments fran√ßais sont disponibles uniquement
au format TSV avec une structure complexe, ce qui rend leur utilisation
programmatique difficile. Cette API transforme ces donn√©es en JSON structur√©
et les expose via une interface RESTful haute performance.

Le projet respecte les termes de la licence de la Base de Donn√©es Publique des
M√©dicaments :

- Les donn√©es proviennent exclusivement de
  [base-donnees-publique.medicaments.gouv.fr](https://base-donnees-publique.medicaments.gouv.fr)
- Aucune alt√©ration ou d√©naturation du sens des donn√©es
- Synchronisation automatique 2 fois par jour (6h et 18h) avec gocron
- La source est mentionn√©e dans la documentation
- Projet ind√©pendant et non affili√© √† l'ANSM, HAS ou UNCAM

## Fonctionnalit√©s

### Points de terminaison

| Endpoint                          | Description                      | Cache     | Co√ªt tokens |
| --------------------------------- | -------------------------------- | --------- | ----------- |
| `GET /database`                   | Base de donn√©es compl√®te         | 6 heures  | 200         |
| `GET /database/{page}`            | Pagination (10 m√©dicaments/page) | 6 heures  | 20          |
| `GET /medicament/{libelle}`       | Recherche par nom (regex)       | 1 heure   | 100         |
| `GET /medicament/id/{cis}`        | Recherche par identifiant CIS    | 12 heures | 100         |
| `GET /generiques/{libelle}`       | Recherche de g√©n√©riques par nom  | 1 heure   | 20          |
| `GET /generiques/group/{groupId}` | Groupe de g√©n√©riques par ID      | 12 heures | 20          |
| `GET /health`                     | √âtat de sant√© du service         | -         | 5           |

### Exemples

```bash
# Base de donn√©es compl√®te
curl https://api.medicaments.fr/database

# Pagination
curl https://api.medicaments.fr/database/1

# Recherche par nom
curl https://api.medicaments.fr/medicament/paracetamol

# Recherche par CIS
curl https://api.medicaments.fr/medicament/id/60904643

# G√©n√©riques
curl https://api.medicaments.fr/generiques/paracetamol
```

## S√©curit√© et robustesse

### Mesures de s√©curit√©

- Validation des entr√©es utilisateur (3-50 caract√®res alphanum√©riques + espaces)
- Protection contre les injections avec `regexp.QuoteMeta`
- Rate limiting par token bucket (1000 tokens initiaux, 3 tokens/sec recharge)
- Middleware de protection (taille requ√™tes: 1MB max, headers: 1MB max)
- Nettoyage automatique des clients inactifs (toutes les 30 minutes)
- Headers de s√©curit√© (CORS via nginx, Content-Type strict)

### Robustesse

- Mises √† jour sans temps d'arr√™t avec `atomic.Value` et `atomic.Bool`
- Gestion des erreurs avec logging structur√© (slog)
- V√©rification horaire des mises √† jour (alerte si >25h sans update)
- Arr√™t propre avec timeout de 30 secondes + 2 secondes pour requ√™tes en cours
- Concurrence s√©curis√©e avec `sync.RWMutex` et atomic operations
- Health monitoring int√©gr√© avec v√©rification toutes les heures

## ‚ö° Performance

### Optimisations

- T√©l√©chargement et traitement parall√®les des 5 fichiers TSV (sp√©cialit√©s, compositions, pr√©sentations, g√©n√©riques, conditions)
- Cache HTTP avanc√© avec headers ETag et Last-Modified
- Compression Gzip (r√©duction de taille jusqu'√† 80%)
- Recherche O(1) via des maps en m√©moire (medicamentsMap, generiquesMap, compositionsMap, etc.)
- Pagination pour √©viter le chargement de la base compl√®te
- Atomic swap pour zero-downtime updates

### M√©triques

- Temps de r√©ponse : < 100ms pour les requ√™tes individuelles
- Mises √† jour : compl√®tes en ~1-2 minutes (d√©pend de la connexion)
- Disponibilit√© : 99.9% avec red√©marrage automatique et graceful shutdown
- Fra√Æcheur des donn√©es : mises √† jour toutes les 12 heures maximum (6h et 18h)
- Dataset : ~15K m√©dicaments avec donn√©es compl√®tes (composition, pr√©sentations, etc.)

## üèóÔ∏è Architecture

### Flux de donn√©es

```text
Source TSV (BDPM) ‚Üí Download concurrent ‚Üí Parsing parall√®le (5 goroutines) ‚Üí
Structuration JSON ‚Üí Stockage en m√©moire (atomic.Value) ‚Üí API REST (Chi router)
```

### Composants

- **Downloader** : t√©l√©chargement concurrent avec gestion d'erreurs et retry
- **Parser** : conversion TSV ‚Üí JSON avec validation et cr√©ation de lookup maps O(1)
- **Data Container** : stockage thread-safe avec `atomic.Value` pour zero-downtime updates
- **API Layer** : Chi router v5 avec middleware stack (RequestID, RealIP, Logging, RateLimiting, etc.)
- **Scheduler** : mises √† jour automatiques avec gocron (6h et 18h)
- **Rate Limiter** : token bucket avec cleanup automatique des clients inactifs

## Documentation

La documentation compl√®te est disponible √† l'adresse racine de l'API :
`https://api.medicaments.fr/`

Elle inclut des exemples interactifs pour chaque endpoint et des r√©ponses
JSON format√©es.

## Stack Technique

- **Langage** : Go 1.21+
- **Framework web** : Chi v5 avec middleware stack
- **Scheduling** : gocron pour les mises √† jour automatiques
- **Logging** : structured logging avec slog et rotation de fichiers
- **Rate limiting** : juju/ratelimit (token bucket algorithm)
- **Encoding** : support Windows-1252 ‚Üí UTF-8 pour les fichiers sources
- **Configuration** : validation d'environnement avec types forts
- **Tests** : tests unitaires avec couverture de code

## Architecture et design

L'architecture privil√©gie la simplicit√© et l'efficacit√© :

- Atomic operations pour les mises √† jour sans temps d'arr√™t
- Architecture stateless facilitant la mont√©e en charge
- Code modulaire avec s√©paration claire des responsabilit√©s
- Optimisation m√©moire et cache intelligent pour des r√©ponses rapides

## Ing√©nierie de production

Le projet int√®gre des pratiques industrielles :

- Health checks et logging structur√© pour le d√©bogage
- Validation des entr√©es et protection contre les abus
- Graceful shutdown et gestion robuste des erreurs
- Code format√©, tests unitaires et documentation compl√®te

## Limitations

Ce service est gratuit et fonctionne avec des ressources limit√©es :

- Rate limiting : 10 requ√™tes par seconde par IP
- Data size : la base compl√®te fait ~20MB en m√©moire
- Pas de SLA : service fourni "as-is" sans garantie
- Mises √† jour : d√©pendantes de la disponibilit√© de la source

## Licence

Ce projet est distribu√© sous licence MIT. Les donn√©es m√©dicales restent
soumises √† la licence de la Base de Donn√©es Publique des M√©dicaments.

---

## D√©velopp√© avec ‚ù§Ô∏è pour la communaut√© m√©dicale fran√ßaise
